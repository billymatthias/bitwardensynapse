{
	"name": "create_calendar_table",
	"properties": {
		"content": {
			"query": "DECLARE @StartDate DATE = '20160101', @NumberOfYears INT = 10;\n\n-- prevent set or regional settings from interfering with \n-- interpretation of dates / literals\n\nCREATE TABLE #dimdate\n(\n  [date]       DATE,  \n  [day]        tinyint,\n  [month]      tinyint,\n  first_of_month date,\n  [month_name]  varchar(12),\n  [week]       tinyint,\n  [ISOweek]    tinyint,\n  [day_of_week]  tinyint,\n  [quarter]    tinyint,\n  [year]       smallint,\n  first_of_year  date,\n  style23     char(10),\n  style101     char(10)\n);\n\n\nSET DATEFIRST 7; -- 7 = Sunday\nSET DATEFORMAT ymd;\nSET LANGUAGE US_ENGLISH;\n\nDECLARE @CutoffDate DATE = DATEADD(YEAR, @NumberOfYears, @StartDate);\n\n-- this is just a holding table for intermediate calculations:\n\n-- use the catalog views to generate as many rows as we need\n\nINSERT #dimdate([date]) \nSELECT d\nFROM\n(\n  SELECT d = DATEADD(DAY, rn - 1, @StartDate)\n  FROM \n  (\n    SELECT TOP (DATEDIFF(DAY, @StartDate, @CutoffDate)) \n      rn = ROW_NUMBER() OVER (ORDER BY s1.[object_id])\n    FROM sys.all_objects AS s1\n    CROSS JOIN sys.all_objects AS s2\n    ORDER BY s1.[object_id]\n  ) AS x\n) AS y;\n\n\nUPDATE #DimDate \nset \n  [day]          = DATEPART(DAY,      [date]),\n  [month]        = DATEPART(MONTH,    [date]),\n  first_of_month = CONVERT(DATE, DATEADD(MONTH, DATEDIFF(MONTH, 0, [date]), 0)),\n  [month_name]   = DATENAME(MONTH,    [date]),\n  [week]         = DATEPART(WEEK,     [date]),\n  [ISOweek]      = DATEPART(ISO_WEEK, [date]),\n  [day_of_week]  = DATEPART(WEEKDAY,  [date]),\n  [quarter]      = DATEPART(QUARTER,  [date]),\n  [year]         = DATEPART(YEAR,     [date]),\n  first_of_year  = CONVERT(DATE, DATEADD(YEAR,  DATEDIFF(YEAR,  0, [date]), 0)),\n  style23        = CONVERT(CHAR(8),   [date], 23),\n  style101       = CONVERT(CHAR(10),  [date], 101)\n;\n\n\nCREATE TABLE dbo.calendar\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN\n)\nAS\nSELECT\n  --datekey          = CONVERT(INT, style23),\n  [date]           = [date],\n  [day]            = CONVERT(TINYINT, [day]),\n  day_suffix       = CONVERT(CHAR(2), CASE WHEN [day] / 10 = 1 THEN 'th' ELSE \n                    CASE RIGHT([day], 1) WHEN '1' THEN 'st' WHEN '2' THEN 'nd' \n\t                WHEN '3' THEN 'rd' ELSE 'th' END END),\n  [weekday]        = CONVERT(TINYINT, [day_of_week]),\n  [weekday_name]   = CONVERT(VARCHAR(10), DATENAME(WEEKDAY, [date])),\n  [dow_in_month]   = CONVERT(TINYINT, ROW_NUMBER() OVER \n                  (PARTITION BY first_of_month, [day_of_week] ORDER BY [date])),\n  [day_of_year]    = CONVERT(SMALLINT, DATEPART(DAYOFYEAR, [date])),\n  week_of_month    = CONVERT(TINYINT, DENSE_RANK() OVER \n                  (PARTITION BY [year], [month] ORDER BY [week])),\n  week_of_year     = CONVERT(TINYINT, [week]),\n  ISO_week_of_year = CONVERT(TINYINT, ISOweek),\n  [month]          = CONVERT(TINYINT, [month]),\n  [month_name]     = CONVERT(VARCHAR(10), [month_name]),\n  [quarter]        = CONVERT(TINYINT, [quarter]),\n  quarter_name     = CONVERT(VARCHAR(6), CASE [quarter] WHEN 1 THEN 'First' \n                     WHEN 2 THEN 'Second' WHEN 3 THEN 'Third' WHEN 4 THEN 'Fourth' END), \n  [Year]           = [year],\n  MMYYYY           = CONVERT(CHAR(6), LEFT(style101, 2)    + LEFT(style23, 4)),\n  month_year       = CONVERT(CHAR(8), LEFT([month_name], 3) + ' ' + LEFT(style23, 4)),\n  first_day_of_month     = first_of_month,\n  last_day_of_month      = MAX([date]) OVER (PARTITION BY [year], [month]),\n  first_day_of_quarter   = MIN([date]) OVER (PARTITION BY [year], [quarter]),\n  last_day_of_quarter    = MAX([date]) OVER (PARTITION BY [year], [quarter]),\n  first_day_of_year      = first_of_year,\n  last_day_of_year       = MAX([date]) OVER (PARTITION BY [year]),\n  first_day_of_next_month = DATEADD(MONTH, 1, first_of_month),\n  first_day_of_next_year  = DATEADD(YEAR,  1, first_of_year)\nFROM #dimdate\n;\n\nDROP Table #dimdate;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "SQLPOOL1",
				"databaseName": "SQLPOOL1"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}